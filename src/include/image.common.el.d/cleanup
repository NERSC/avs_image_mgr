# $Id: cleanup 54 2013-09-10 21:49:03Z larry $

# Auto-Versioning Systems Image Manager, Copyright (c) 2013, The
# Regents of the University of California, through Lawrence Berkeley
# National Laboratory (subject to receipt of any required approvals
# from the U.S. Dept. of Energy).  All rights reserved.
# 
# If you have questions about your rights to use or distribute this
# software, please contact Berkeley Lab's Technology Transfer
# Department at TTD@lbl.gov.
# 
# NOTICE.  This software is owned by the U.S. Department of Energy.
# As such, the U.S. Government has been granted for itself and others
# acting on its behalf a paid-up, nonexclusive, irrevocable, worldwide
# license in the Software to reproduce, prepare derivative works, and
# perform publicly and display publicly.  Beginning five (5) years
# after the date permission to assert copyright is obtained from the
# U.S. Department of Energy, and subject to any subsequent five (5)
# year renewals, the U.S. Government is granted for itself and others
# acting on its behalf a paid-up, nonexclusive, irrevocable, worldwide
# license in the Software to reproduce, prepare derivative works,
# distribute copies to the public, perform publicly and display
# publicly, and to permit others to do so.

setup_remove_python () {
    # See https://bugzilla.redhat.com/show_bug.cgi?id=203327
    rpm --root=$IMGROOT --nodeps -e python #python-libs
    rm -rf $IMGROOT/usr/lib/python2.4/ $IMGROOT/usr/lib64/python2.4/
}

setup_remove_man_pages () {
    echo
    #rm -rf $IMGROOT/usr/share/man
}

setup_remove_doc () {
    echo
    #rm -rf $IMGROOT/usr/share/doc
}

setup_remove_locales () {
    echo
    #for _LOCALE_DIR in $IMGROOT/usr/lib/locale $IMGROOT/usr/share/locale; do
    #    cd $_LOCALE_DIR
    #    for i in *; do 
    #        if [[ "$i" != "${KEEP_LOCALE}" ]]; then
    #            rm --one-file-system -rf "${_LOCALE_DIR}/$i"
    #        fi
    #    done
    #done
}

setup_remove_zoneinfo () {
    rm -rf $IMGROOT/usr/share/zoneinfo
    case $OS_FAMILY in
        el5 ) 
            ;;
        el6 ) 
            mkdir $IMGROOT/usr/share/zoneinfo
            cp /usr/share/zoneinfo/UTC $IMGROOT/usr/share/zoneinfo
            ;;
    esac
}
setup_remove_info () {
    echo
    #rm -rf $IMGROOT/usr/share/info
}
setup_remove_i18n () {
    rm -rf $IMGROOT/usr/share/i18n
}
setup_remove_cracklib () {
    rm -rf $IMGROOT/usr/share/cracklib
}

cleanup () {

    case $OS_FAMILY in
        el5 ) 
            ;;
        el6 ) 
            $YUM erase cronie-anacron
            in_target chkconfig nslcd off
            in_target chkconfig portreserve on
            ;;
    esac

    # Link some additional busybox utilities
    ln -s /sbin/busybox $IMGROOT/bin/which
    if [ ! -e $IMGROOT/bin/vi ]; then
        ln -s /sbin/busybox $IMGROOT/bin/vi
    fi
    ln -s /sbin/busybox $IMGROOT/bin/diff
    ln -s /sbin/busybox $IMGROOT/bin/patch


    #echo 'CLOCKFLAGS=--debug' > $IMGROOT/etc/sysconfig/clock
    $YUM --enablerepo='*' clean all

    # "yum clean all" does not seem to really clean up
    # /var/cache/yum/, so we clean it up by hand
    rm -rf $IMGROOT/var/cache/yum
    rm -rf $IMGROOT/var/log/yum.log

    [ ! -d $IMGROOT/misc ] || rmdir $IMGROOT/misc

    case $OS_FAMILY in
        el5 ) 
            sed -ie 's/Boron)/Boron) for '$SYSTEMNAME'/g' $IMGROOT/etc/issue
            ;;
        el6 ) 
            sed -ie 's/Carbon)/Carbon) for '$SYSTEMNAME'/g' $IMGROOT/etc/issue
            sed -ie 's/\(\\m\)/\1 (\\l)/g' $IMGROOT/etc/issue
            rm -rf $IMGROOT/var/lib/yum/yumdb
            rm -rf $IMGROOT/var/lib/yum/history
            rm -rf $IMGROOT/var/lib/yum/uuid
            rm -rf $IMGROOT/usr/share/wallpapers
            rm -rf $IMGROOT/usr/share/backgrounds
            rm -rf $IMGROOT/usr/share/firstboot
            rm -f $IMGROOT/etc/modprobe.conf
            ;;
    esac

    rm -rf $IMGROOT/usr/local

    rm -rf $IMGROOT/usr/src
    rm -rf $IMGROOT/usr/lib/debug

    rm -rf $IMGROOT/boot/initrd*

    rm -f $IMGROOT/etc/aliases.db
    rm -f $IMGROOT/etc/mail/virtusertable.db
    rm -f $IMGROOT/etc/mail/access.db
    rm -f $IMGROOT/etc/mail/domaintable.db
    rm -f $IMGROOT/etc/mail/mailertable.db

    #rm -rf $IMGROOT/lib/modules/*/kernel/sound/
    #rm -rf $IMGROOT/lib/modules/*/kernel/drivers/isdn



    
    rm -rf $IMGROOT/scratch/image_build
    rm -rf $IMGROOT/data
    rm -rf $IMGROOT/xcatpost


    in_target chkconfig auditd off
    in_target chkconfig cgconfig off
    in_target chkconfig cpuspeed on
    in_target chkconfig iptables off
    in_target chkconfig ip6tables off ||/bin/true
    in_target chkconfig nscd on
    in_target chkconfig --add smartd
    in_target chkconfig rpcidmapd off || /bin/true
    in_target chkconfig rpcgssd off || /bin/true

    case $OS_FAMILY in
        el5 ) 
            in_target chkconfig lvm2-monitor off || /bin/true
            in_target chkconfig lvm2-monitor --level 1 off || /bin/true
            ;;
    esac

    in_target chkconfig nfs off || /bin/true
    
    # We start sysstat after other postscripts are run
    in_target chkconfig sysstat off || /bin/true

    # Delete these NSS .chk files as the RPM installation process
    # generates them differentely every time See:.
    # http://www.mozilla.org/projects/security/pki/nss/tech-notes/tn6.html
    # Re-enable if needed
    rm -f $IMGROOT/usr/lib64/libfreebl3.chk
    rm -f $IMGROOT/usr/lib64/libsoftokn3.chk


    if [ -e $IMGROOT/var/log ]; then
        rm -rf $IMGROOT/var/log
    fi

    mkdir $IMGROOT/var/log

    ERRS="$(in_target depmod -ae $(kernel_variant) -F /boot/System.map-$(kernel_variant) 2>&1)"

    if [ ! -z "$ERRS" ]; then
        echo "$ERRS"
        fail "depmod failed to resolve all symbols"
    fi


}

# Removes the RPM database.  This saves space, but removes the
# ability to interrogate a running image about package management
# information
setup_remove_rpm_db () {
    rpm --root $IMGROOT -qa > $IMGROOT/etc/rpms
    rm -rf $IMGROOT/var/lib/rpm

    # Add a basic RPM wrapper script to provide fake support for
    # some basic RPM functions
    cat > $IMGROOT/bin/rpm << 'EOF'
#!/bin/sh

set -Eeu

while [ $# -gt 0 ]; do
    if [[ "$1" == "-qa" ]]; then
        cat /etc/rpms
    fi
    shift
done

exit 0
EOF
    chmod +x $IMGROOT/bin/rpm
    #ln -sf /sbin/busybox $IMGROOT/bin/rpm
}

