# $Id: additional_packages 69 2013-10-13 00:37:28Z larry $

# Auto-Versioning Systems Image Manager, Copyright (c) 2013, The
# Regents of the University of California, through Lawrence Berkeley
# National Laboratory (subject to receipt of any required approvals
# from the U.S. Dept. of Energy).  All rights reserved.
# 
# If you have questions about your rights to use or distribute this
# software, please contact Berkeley Lab's Technology Transfer
# Department at TTD@lbl.gov.
# 
# NOTICE.  This software is owned by the U.S. Department of Energy.
# As such, the U.S. Government has been granted for itself and others
# acting on its behalf a paid-up, nonexclusive, irrevocable, worldwide
# license in the Software to reproduce, prepare derivative works, and
# perform publicly and display publicly.  Beginning five (5) years
# after the date permission to assert copyright is obtained from the
# U.S. Department of Energy, and subject to any subsequent five (5)
# year renewals, the U.S. Government is granted for itself and others
# acting on its behalf a paid-up, nonexclusive, irrevocable, worldwide
# license in the Software to reproduce, prepare derivative works,
# distribute copies to the public, perform publicly and display
# publicly, and to permit others to do so.

# Install many miscellaneous useful packages
# TODO: This function needs to be modularized
# and cleaned up
setup_additional_packages () {
    $YUM install audit
    in_target chkconfig auditd off

    #$YUM install diff vim-enhanced tcsh libXmu iptables net-snmp
    #$YUM install diff vim-enhanced tcsh iptables net-snmp
    #$YUM install diff tcsh iptables net-snmp sendmail
    $YUM install tcpdump iperf telnet nc traceroute

    $YUM install lvm2

    $YUM install psacct
    $YUM install numactl
    $YUM install libcgroup
    in_target chkconfig cgconfig off

    # Disable colorls by default
    $YUM install SL_no_colorls

    # Workload generator
    $YUM install stress

    # CPU frequency settings
    $YUM install cpufrequtils i7z cpuspeed
    cp $IMAGEFILES/sysconfig.cpuspeed $IMGROOT/etc/sysconfig/cpuspeed
    in_target chkconfig cpuspeed on

    # Useful for debugging and diagnostics
    $YUM install dmidecode pciutils strace mcelog

    # Provide the ability to read manpages, but disable the cronjob
    # that builds the whatis database
    $YUM install man
    rm -f $IMGROOT/etc/cron.daily/makewhatis.cron

    # rsync is required for xCAT syncfiles
    $YUM install rsync

    # Install attr to get and manipulate extended attributes
    # (Required for XRootD)
    $YUM install attr

    $YUM install iptables
    in_target chkconfig iptables off
    in_target chkconfig ip6tables off ||/bin/true

    $YUM install lsof
    case $OS_FAMILY in
        el5 ) 
	    $YUM install smartmontools
	    $YUM install nss_ldap
            in_target chkconfig nscd on
            ;;
        el6 ) 
	    $YUM install smartmontools
	    $YUM install unscd nss-pam-ldapd
            cp ${IMAGEFILES}/unscd.conf ${IMGROOT}/etc/unscd.conf
	    $YUM install portreserve
            echo 790/tcp > $IMGROOT/etc/portreserve/gpfs            
            echo 790/udp >> $IMGROOT/etc/portreserve/gpfs            
            echo 791/tcp >> $IMGROOT/etc/portreserve/gpfs            
            echo 791/udp >> $IMGROOT/etc/portreserve/gpfs            
            in_target chkconfig nscd on
            in_target chkconfig nslcd off
            in_target chkconfig portreserve on
            ;;
    esac

    in_target chkconfig --add smartd

    case $OS_FAMILY in
        el5 ) 
	    $YUM install crontabs
            ;;
        el6 ) 
	    $YUM install crontabs cronie-noanacron
	    $YUM erase cronie-anacron
            ;;
    esac

    rm -f $IMGROOT/etc/cron.daily/logrotate

    # Install a restrictive set of default IPTables rules
    cp $IMAGEFILES/etc/iptables $IMGROOT/etc/sysconfig/iptables

    $YUM install dhclient
    $YUM install tcsh

    case $OS_FAMILY in
        el5 ) 
	    $YUM install sysklogd
            ;;
        el6 ) 
	    $YUM install rsyslog
            ;;
    esac


    # wget is needed by /opt/xcat/xcatdsklspost to download postscripts
    # (Busybox wget does not seem to have the required features.)
    $YUM install wget

    # Link some additional busybox utilities
    ln -s /sbin/busybox $IMGROOT/bin/which
    if [ ! -e $IMGROOT/bin/vi ]; then
        ln -s /sbin/busybox $IMGROOT/bin/vi
    fi
    ln -s /sbin/busybox $IMGROOT/bin/diff
    ln -s /sbin/busybox $IMGROOT/bin/patch
 
    [ -e $IMGROOT/usr/sbin/usernetctl ] && chmod u-s $IMGROOT/usr/sbin/usernetctl


}

